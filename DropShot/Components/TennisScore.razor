@using System.ComponentModel.DataAnnotations
@using DropShot.Models;
@using DropShot.Data;
@using Microsoft.EntityFrameworkCore
@using System;
@using System.Collections.Generic;
@using System.Text.Json

@page "/tennisscore"
@rendermode InteractiveServer

<div class="score-container">
    <!-- Top Player Button -->
    <button name="btnUserWinsPoint" class="initial-circle" @onclick="UserWinsPoint" disabled="@isMatchEnded">
        AB
    </button>
    <!-- Score Display -->
    <div class="score-display">
        <div class="score-row">

            @if (isUserServing)
            {
                <span class="sets serve-indicator">🎾</span>
            }
            else
            {
                <span class="sets serve-indicator"></span>
            }

            <span class="sets">@userSets</span> | <span class="sets">@userGames</span> | <span class="sets">@ScoreDisplayUser</span>
        </div>
        <div class="score-row">

            @if (!isUserServing)
            {
                <span class="sets serve-indicator">🎾</span>
            }
            else
            {
                <span class="sets serve-indicator"></span>
            }
            <span class="sets">@opponentSets</span> | <span class="sets">@opponentGames</span> | <span class="sets">@ScoreDisplayOpp</span>
        </div>
    </div>



    <!-- Bottom Player Button -->
    <button name="btnOppWinsPoint" class="initial-circle" @onclick="OpponentWinsPoint" disabled="@isMatchEnded">
        AB
    </button>
</div>
<button class="btn btn-secondary" @onclick="UndoLastPoint" disabled="@(!history.Any())">Undo</button>

<div style="display: flex">

    <DotDigit Number="@userSets" />
    <DotDigit Number="@opponentSets" />
    <DotDigit Number="@userGames" />
    <DotDigit Number="@opponentGames" />
 

</div>

<div style="display: flex">

    <DotDigit Number="@userSets" />
    <DotDigit Number="@opponentSets" />
    <DotDigit Number="@userGames" />
    <DotDigit Number="@opponentGames" />


</div>

@code {
    private int userPoints = 0;
    private int opponentPoints = 0;
    private int userGames = 0;
    private int opponentGames = 0;
    private int userSets = 0;
    private int opponentSets = 0;
    private bool isTieBreak = false;
    private int bestOf = 5;
    private int gamesFirstTo = 6;
    private int maxDeuce = 0;
    private bool isUserServing = true; // Start with user serving

    private int deuceCount = 0;
    private bool isMatchEnded = false;

    private Stack<(int userPts, int oppPts, int userG, int oppG, int userS, int oppS, bool tieBreak, int deuceCount, bool isUserServing)> history = new();

    private string ScoreDisplayOpp
    {
        get
        {
            if (isTieBreak)
                return $"{opponentPoints}";

            if (userPoints >= 3 && opponentPoints >= 3)
            {
                if (userPoints == opponentPoints)
                    return (userPoints == 3) ? "40 - 40" : "D";
                if (userPoints == opponentPoints + 1) return "A - AB";
                if (opponentPoints == userPoints + 1) return "A - CD";
            }
            return $"{ConvertToTennisScore(opponentPoints)}";
        }
    }

    private string ScoreDisplayUser
    {
        get
        {
            if (isTieBreak)
                return $"{userPoints}";

            if (userPoints >= 3 && opponentPoints >= 3)
            {
                if (userPoints == opponentPoints)
                    return (userPoints == 3) ? "40 - 40" : "D";
                if (userPoints == opponentPoints + 1) return "A - CD";
                if (opponentPoints == userPoints + 1) return "A - AB";
            }
            return $"{ConvertToTennisScore(userPoints)}";
        }
    }

    private void UserWinsPoint()
    {
        SaveHistory();
        userPoints++;
        CheckGame();
    }

    private void OpponentWinsPoint()
    {
        SaveHistory();
        opponentPoints++;
        CheckGame();
    }

    private void UndoLastPoint()
    {
        if (history.Any())
        {
            var last = history.Pop();
            userPoints = last.userPts;
            opponentPoints = last.oppPts;
            userGames = last.userG;
            opponentGames = last.oppG;
            userSets = last.userS;
            opponentSets = last.oppS;
            isTieBreak = last.tieBreak;
            deuceCount = last.deuceCount;
            isMatchEnded = false;
            isUserServing = last.isUserServing;
        }
    }

    private void SaveHistory()
    {
        history.Push((userPoints, opponentPoints, userGames, opponentGames, userSets, opponentSets, isTieBreak, deuceCount, isUserServing));
        var stackList = history.ToList();
        string json = JsonSerializer.Serialize(stackList);
    }

    private void CheckGame()
    {
        if (isTieBreak)
        {
            if ((userPoints >= 7 || opponentPoints >= 7) && Math.Abs(userPoints - opponentPoints) >= 2)
            {
                if (userPoints > opponentPoints)
                    userSets++;
                else
                    opponentSets++;
                EndSet();
            }

            var dsd = (userPoints + opponentPoints) % 2;

            if  (dsd == 1)
                isUserServing = !isUserServing; 
            return;
        }

        // Increment deuce count
        if (userPoints >= 3 && opponentPoints >= 3 && userPoints == opponentPoints)
            deuceCount += 1;

        if (userPoints >= 4 || opponentPoints >= 4)
        {
            int diff = userPoints - opponentPoints;

            if (!(deuceCount > maxDeuce))
            {
                // Normal tennis logic before deuce
                if (diff >= 2)
                {
                    userGames++;
                    ResetGame();
                    CheckSet();
                }
                else if (diff <= -2)
                {
                    opponentGames++;
                    ResetGame();
                    CheckSet();
                }
            }
            else
            {
                if (diff == 2 || diff == -2 || (diff == 1 && opponentPoints > 3) || (diff == -1 && userPoints > 3) || deuceCount > maxDeuce)
                {
                    if (diff > 0)
                        userGames++;
                    else
                        opponentGames++;
                    ResetGame();
                    CheckSet();
                }
            }
        }
    }

    private void CheckSet()
    {
        if (userGames == 6 && opponentGames == 6)
        {
            isTieBreak = true;
            userPoints = opponentPoints = 0;
            return;
        }

        if ((userGames >= 6 || opponentGames >= 6) && Math.Abs(userGames - opponentGames) >= 2)
        {
            if (userGames > opponentGames)
                userSets++;
            else
                opponentSets++;

            EndSet();
        }
    }

    private int GetMaxSetsToWin(int bestOf)
    {
        switch (bestOf)
        {
            case 3:
                return 2;
            case 5:
                return 3;
            case 7:
                return 4;
            default:
                return 0;
        }
    }

    private void EndSet()
    {
        userGames = opponentGames = 0;
        userPoints = opponentPoints = 0;
        isTieBreak = false;

        // Check match win condition dynamically
        if (userSets == GetMaxSetsToWin(bestOf) || opponentSets == GetMaxSetsToWin(bestOf))
        {
            EndMatch();
            // ResetMatch();
        }
    }

    private void EndMatch()
    {
        isMatchEnded = true;
        Console.WriteLine(userSets > opponentSets ? "User wins the match!" : "Opponent wins the match!");
    }

    private void ResetGame()
    {
        userPoints = 0;
        opponentPoints = 0;
        isUserServing = !isUserServing;
    }

    private void ResetMatch()
    {
        userPoints = opponentPoints = 0;
        userGames = opponentGames = 0;
        userSets = opponentSets = 0;
        isTieBreak = false;
        isMatchEnded = false;
        history.Clear();
    }

    private string ConvertToTennisScore(int points) => points switch
    {
        0 => "0",
        1 => "15",
        2 => "30",
        3 => "40",
        _ => "40"
    };
}