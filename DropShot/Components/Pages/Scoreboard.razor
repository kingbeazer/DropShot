@page "/score"
@rendermode InteractiveServer
@using DropShot.Data
@using DropShot.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.EntityFrameworkCore
@using Newtonsoft.Json
@inject NavigationManager Navigation
  

@inject MyDbContext DbContext


<div style="display: flex">
    @foreach (var set in currentScore.SetScores)
    {
        <DotDigit Number="@set.UserGames" />
    }
    <DotDigit Number="@currentScore.UserG" />
    @for (int i = 0; i < 5 - currentScore.SetScores.Count() -1 ; i++)
    {
        <DotDigit Number="0" />
    }
</div>

<div style="display: flex">
    @foreach (var set in currentScore.SetScores)
    {
        <DotDigit Number="@set.OpponentGames" />
    }
    <DotDigit Number="@currentScore.OppG" />
    @for (int i = 0; i < 5 - currentScore.SetScores.Count() -1; i++)
    {
        <DotDigit Number="0" />
    }
</div>

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">The Story Book</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudText>This day everything happened.</MudText>
        <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
    </MudCardContent>
    <MudCardActions>
        <MudButton Variant="Variant.Text" Color="Color.Primary">Read more</MudButton>
    </MudCardActions>
</MudCard>
@code {
    private HubConnection? hubConnection;
    private string? userInput;
    private string? messageInput;
    private List<string> messages = new();
    private List<Score> scores = new();
    private Stack<GameState> history = new();
    GameState currentScore = new(0, 0, 0, 0, 0, 0, false, 0, true, 0, 0, new List<SetScore>());

    protected override async Task OnInitializedAsync()
    {
        scores = await DbContext.Score.ToListAsync();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<string, string>("ReceiveMessage", async (user, message) =>
        {
            // FIX: Use nullable type and null check to avoid CS8600
            GameState? gameState = JsonConvert.DeserializeObject<GameState>(user);
            if (gameState != null)
            {
                currentScore = gameState;
            }
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

      public record GameState(
        int UserPts,
        int OppPts,
        int UserG,
        int OppG,
        int UserS,
        int OppS,
        bool TieBreak,
        int DeuceCount,
        bool IsUserServing,
        int UserGamesSnapshot,
        int OpponentGamesSnapshot,
        List<SetScore>? SetScores
    );

    public class SetScore
    {
        public int SetNumber { get; set; }
        public int UserGames { get; set; }
        public int OpponentGames { get; set; }
    }

    private void SendMessage()
    {
        Console.WriteLine("SendMessage clicked"); // 👈 log to browser console


        if (hubConnection is not null && !string.IsNullOrWhiteSpace(userInput) && !string.IsNullOrWhiteSpace(messageInput))
        {
              hubConnection.SendAsync("SendMessage", userInput, messageInput);
            messageInput = string.Empty;
        }
    }

    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;
}

